<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Breeding Simulator 2016</title>
</head>
<body>
  <h1>GENOME VALIDATOR</h1>
  <form>
    <h2>Genome</h2>
      <input type=text id="genes_input">
      <h3>Recognized genes</h3>
      <p>Type a genome and see if I can recognize it. "nn" genes are just ignored so leave them out if you like<br></p>
      <ul id="genes_output"></ul>
  </form>
  <script>
    var genes_input = document.getElementById("genes_input");
    var genes_output = document.getElementById("genes_output");

    var empty_pair = "nn"

    var re_genes = [
      /*OUTPUT WILL BE IN THIS ORDER
        gene: gene name, regex, required*/
      ["Extension", new RegExp("^(E|e)(E|e)$"), true],
      ["Agouti", new RegExp("^(A|Ay|Ad|At|a)(A|Ay|Ad|At|a)$"), true],
      ["C gene", new RegExp("^(n|C)(n|C)$"), false],
      ["B gene", new RegExp("^(n|B)(n|B)$"), false],
      ["Z gene", new RegExp("^(n|Z)(n|Z)$"), false],
      ["D gene", new RegExp("^(n|D)(n|D)$"), false],
      ["Pearl", new RegExp("^(n|prl)(n|prl)$"), false],
      ["X gene", new RegExp("^(n|X)(n|X)$"), false],
      ["Y gene", new RegExp("^(n|Y)(n|Y)$"), false],
      ["O gene", new RegExp("^(n|O|Od)(n|O|Od)$"), false],
      ["P gene", new RegExp("^(n|P)(n|P)$"), false],
      ["R gene", new RegExp("^(n|R|rs)(n|R|rs)$"), false],
      ["Dty gene", new RegExp("^(n|Dty)(n|Dty)$"), false],
      ["Mnt gene", new RegExp("^(n|Mnt)(n|Mnt)$"), false],
      ["V gene", new RegExp("^(n|V)(n|V)$"), false],
      ["Sph gene", new RegExp("^(n|Sph)(n|Sph)$"), false],
      ["U gene", new RegExp("^(n|U)(n|U)$"), false],
      ["f gene", new RegExp("^(n|f)(n|f)$"), false],
      ["Fr gene", new RegExp("^(n|Fr)(n|Fr)$"), false],
      ["Sk gene", new RegExp("^(n|Sk)(n|Sk)$"), false],
      ["Smr gene", new RegExp("^(n|Smr)(n|Smr)$"), false],
      ["M gene", new RegExp("^(n|M)(n|M)$"), false],
      ["Cp gene", new RegExp("^(n|Cp)(n|Cp)$"), false],
      ["Sdl gene", new RegExp("^(n|Sdl)(n|Sdl)$"), false],
      ["Fwl gene", new RegExp("^(n|Fwl)(n|Fwl)$"), false],
      ["G gene", new RegExp("^(n|G)(n|G)$"), false],
      ["Kd gene", new RegExp("^(n|Kd)(n|Kd)$"), false],
      ["Q gene", new RegExp("^(n|Q|q)(n|Q|q)$"), false],
      ["P weird", new RegExp("^(n|Pm|Pp|Pc)(n|Pm|Pp|Pc)$"), false],
      ["wlf gene", new RegExp("^(n|wlf)(n|wlf)$"), false],
      ["Ld gene", new RegExp("^(n|Ld)(n|Ld)$"), false],
      ["Ink gene", new RegExp("^(n|Ink)(n|Ink)$"), false],
      ["Crc gene", new RegExp("^(n|Crc)(n|Crc)$"), false],
      ["Bl gene", new RegExp("^(n|Bl)(n|Bl)$"), false],
      ["Cdr gene", new RegExp("^(n|Cdr)(n|Cdr)$"), false],
      ["Fwn gene", new RegExp("^(n|Fwn)(n|Fwn)$"), false],
      ["I gene", new RegExp("^(n|I)(n|I)$"), false],
      ["S something", new RegExp("^(n|Sp|Sb)(n|Sp|Sb)$"), false],
      ["W gene", new RegExp("^(n|W)(n|W)$"), false],
      ["Bd gene", new RegExp("^(n|Bd)(n|Bd)$"), false],
      ["Gvl gene", new RegExp("^(n|Gvl)(n|Gvl)$"), false],
      ["N gene", new RegExp("^(n|N\\+|N\\-|No)(n|N\\+|N\\-|No)$"), false],
    ]
    function str_to_gene(str) {
      var gene_name, gene;

      /*go through known genes to see if one of them
       matches with input*/
      for (var i=0; i<re_genes.length; i++) {
        gene_name = re_genes[i][0];
        var re_gene = re_genes[i][1];
        gene = str.match(re_gene);
        if (gene !== null)
          break;
      }

      if (gene === null) {
        /*failed to identify the gene*/
        return null;
      }

      gene_left = gene[1];
      gene_right = gene[2];
      return [gene_name, gene_left, gene_right];
    }

    function verify_required(genome) {
      for (var i=0; i<re_genes.length; i++) {
        var gene_template = re_genes[i];
        var gene_required = gene_template[2];
        var gene_name = gene_template[0];
        if (gene_required && !(gene_name in genome)) {
          return false;
        }
      }
      return true;
    }

    function str_to_genome(str) {
      var genome = {};
      var re_geneseparator = /[ ]+/;

      var genelist = str.split(re_geneseparator);
      for (var i=0; i<genelist.length; i++) {
        var genestr = genelist[i];
        if (genestr === "") continue; //first or last might be empty because of splitting
        if (genestr === empty_pair) continue; //explicitly ignore empty pairs
        var gene = str_to_gene(genestr);
        if (gene === null) {
          /*there's an unrecognized gene*/
          console.log("FAILED TO IDENTIFY A GENE");
          return null;
        } else if (gene[0] in genome) {
          /*duplicate gene definition*/
          console.log("A GENE WAS DEFINED TWICE");
          return null;
        } else {
          genome[gene[0]] = [gene[1], gene[2]];
        }
      }
      if (!verify_required(genome)) {
        /*a required gene is missing*/
        console.log("REQUIRED GENE MISSING");
        return null
      }
      return genome;
    }

    genes_input.oninput = function() {
      genes_output.innerHTML = "";
      var genome = str_to_genome(genes_input.value);
      if (genome === null) {
        genes_output.innerHTML = "<li>Not valid genome</li>";
        return;
      }
      console.log(genome);
      for (var i=0; i<re_genes.length; i++) {
        var gene_template = re_genes[i];
        var gene_name = gene_template[0];
        console.log(gene_name);
        if (!(gene_name in genome)) continue;
        genes_output.innerHTML += "<li>";
        genes_output.innerHTML += gene_name;
        genes_output.innerHTML += " - ";
        genes_output.innerHTML += genome[gene_name][0];
        genes_output.innerHTML += ",";
        genes_output.innerHTML += genome[gene_name][1];
        genes_output.innerHTML += "</li>";
      }
    }
  </script>
</body>
</html>
