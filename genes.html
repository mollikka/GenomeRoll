<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Breeding Simulator 2016</title>
</head>
<body>
  <h1>GENOROLLER FOR LIZARDS OR WHATEVER</h1>
  <form>
    <h2>Genome</h2>
      <input type=text id="genes_input">
      <h3>Recognized genes</h3>
      <ul id="genes_output"></ul>
  </form>
  <script>
    var genes_input = document.getElementById("genes_input");
    var genes_output = document.getElementById("genes_output");

    var re_genes = [
      /*gene name; regex*/
      ["Extension", new RegExp("^(E|e)(E|e)$")],
      ["Agouti", new RegExp("^(A|a)(A|a)$")],
      ["O_gene", new RegExp("^(n|O|Od)(n|O|Od)$")],
    ]
    function str_to_gene(str) {
      var gene_name, gene;

      /*go through known genes to see if one of them
       matches with input*/
      for (var i=0; i<re_genes.length; i++) {
        gene_name = re_genes[i][0];
        var re_gene = re_genes[i][1];
        gene = str.match(re_gene);
        if (gene !== null)
          break;
      }

      if (gene === null) {
        /*failed to identify the gene*/
        return null;
      }

      gene_left = gene[1];
      gene_right = gene[2];
      return [gene_name, gene_left, gene_right];
    }

    function verify_required(genome) {
      for (var i=0; i<re_genes.length; i++) {
        var gene_template = re_genes[i];
        var gene_required = gene_template[2];
        var gene_name = gene_template[0];
        if (gene_required && !(gene_name in genome)) {
          return false;
        }
      }
      return true;
    }

    function str_to_genome(str) {
      var genome = {};
      var re_geneseparator = / nn |[ ]+/;

      var genelist = str.split(re_geneseparator);
      for (var i=0; i<genelist.length; i++) {
        var genestr = genelist[i];
        if (genestr === "") continue; //first or last might be empty because of splitting
        var gene = str_to_gene(genestr);
        if (gene === null) {
          /*there's an unrecognized gene*/
          console.log("FAILED TO IDENTIFY A GENE");
          return null;
        } else if (gene[0] in genome) {
          /*duplicate gene definition*/
          console.log("A GENE WAS DEFINED TWICE");
          return null;
        } else {
          genome[gene[0]] = [gene[1], gene[2]];
        }
      }
      if (!verify_required(genome)) {
        /*a required gene is missing*/
        console.log("REQUIRED GENE MISSING");
        return null
      }
      return genome;
    }

    genes_input.oninput = function() {
      genes_output.innerHTML = "";
      var genome = str_to_genome(genes_input.value);
      if (genome === null) {
        return;
      }
      console.log(genome);
      for (var key in genome) {
        genes_output.innerHTML += "<li>";
        genes_output.innerHTML += key;
        genes_output.innerHTML += " - ";
        genes_output.innerHTML += genome[key][0];
        genes_output.innerHTML += ",";
        genes_output.innerHTML += genome[key][1];
        genes_output.innerHTML += "</li>";
      }
    }
  </script>
</body>
</html>
